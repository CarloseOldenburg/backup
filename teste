#!/bin/bash

# ========================
# CONFIGURAÇÕES
# ========================
VERSION="1.0"
LOG_FILE="/var/log/vsd-launcher.log"
SCRIPT_URL="https://raw.githubusercontent.com/CarloseOldenburg/updater/main/vsd-launcher"

# ========================
# CORES
# ========================
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# ========================
# FUNÇÕES DE LOG E MENSAGENS
# ========================
function log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') | $1" | sudo tee -a "$LOG_FILE" >/dev/null
}

function info() {
    echo -e "${GREEN}[INFO]${NC} $1"
    log "[INFO] $1"
}

function warn() {
    echo -e "${YELLOW}[ATENÇÃO]${NC} $1"
    log "[ATENÇÃO] $1"
}

function error() {
    echo -e "${RED}[ERRO]${NC} $1"
    log "[ERRO] $1"
}

# ========================
# CHECK DE ATUALIZAÇÃO
# ========================
function check_update() {
    remote_script=$(curl -s "$SCRIPT_URL")
    remote_version=$(echo "$remote_script" | grep "VERSION=" | head -1 | cut -d'"' -f2)

    if [[ -z "$remote_version" ]]; then
        warn "Não foi possível verificar a versão remota."
        return
    fi

    if [[ "$remote_version" != "$VERSION" ]]; then
        warn "Nova versão disponível: $remote_version"
        if whiptail --title "Atualização Disponível" --yesno "Deseja atualizar o vsd-launcher para a versão $remote_version?" 10 60; then
            sudo curl -s -o /usr/bin/vsd-launcher "$SCRIPT_URL"
            sudo chmod +x /usr/bin/vsd-launcher
            info "Atualizado para versão $remote_version."
            exit 0
        else
            warn "Atualização ignorada."
        fi
    else
        info "Você está na versão mais recente ($VERSION)."
    fi
}

# ========================
# FUNÇÕES PRINCIPAIS
# ========================
function clear_cache() {
    rm -rf ~/.cache/google-chrome/* ~/.config/google-chrome/*
    info "Cache do Google Chrome limpo."
}

function clear_token() {
    clear_cache
    sudo rm -f /opt/videosoft/vs-os-interface/log/_database_token*
    sudo rm -f /opt/videosoft/vs-os-interface/log/_database_recovery*
    info "Token e arquivos de recuperação excluídos."
}

function update_url() {
    local service="$1"
    local version="$2"
    local homolog="$3"
    local new_url=""

    if [[ "$service" == "food" ]]; then
        if [[ "$version" == "2" ]]; then
            [[ "$homolog" == "true" ]] && new_url="https://food2.homolog.vsd.app" || new_url="https://food2.vsd.app"
        else
            [[ "$homolog" == "true" ]] && new_url="https://food.homolog.vsd.app" || new_url="https://food.vsd.app"
        fi
    elif [[ "$service" == "self" ]]; then
        [[ "$homolog" == "true" ]] && new_url="https://selfcheckout.homolog.vsd.app" || new_url="https://selfcheckout.vsd.app"
    else
        error "Serviço desconhecido."
        return 1
    fi

    sudo sed -i "s|^VS_URL_APP=.*|VS_URL_APP=\"$new_url\"|" /opt/videosoft/vs-food-launcher/app/vs-food.sh
    info "URL atualizada para: $new_url"
}

# ========================
# MENU INTERATIVO
# ========================
function menu() {
    while true; do
        OPTION=$(whiptail --title "VSD Launcher" --menu "Escolha uma opção:" 20 60 10 \
            "1" "Atualizar URL" \
            "2" "Limpar cache do Chrome" \
            "3" "Limpar token + cache" \
            "4" "Verificar atualizações" \
            "5" "Desinstalar vsd-launcher" \
            "6" "Sair" 3>&1 1>&2 2>&3)

        case $OPTION in
            1) menu_update_url ;;
            2) clear_cache ;;
            3) clear_token ;;
            4) check_update ;;
            5) uninstall ;;
            6) info "Saindo..."; exit 0 ;;
            *) warn "Opção inválida";;
        esac

        whiptail --title "Operação concluída" --msgbox "Operação finalizada com sucesso!" 10 60
    done
}

function menu_update_url() {
    SERVICE=$(whiptail --title "Escolha o serviço" --menu "Selecione:" 15 50 2 \
        "food" "Sistema Food" \
        "self" "Selfcheckout" 3>&1 1>&2 2>&3)

    VERSION=$(whiptail --title "Escolha a versão" --menu "Versão (Food apenas):" 15 50 3 \
        "2" "Food 2.0" \
        "3" "Food 3.0 (Padrão)" \
        "none" "Não especificar" 3>&1 1>&2 2>&3)

    HOMOLOG=$(whiptail --title "Ambiente" --yesno "Usar ambiente de HOMOLOGAÇÃO?" 10 60 && echo "true" || echo "false")

    [[ "$VERSION" == "none" ]] && VERSION=""

    update_url "$SERVICE" "$VERSION" "$HOMOLOG"
}

# ========================
# DESINSTALAÇÃO
# ========================
function uninstall() {
    if whiptail --title "Desinstalar" --yesno "Deseja realmente desinstalar o vsd-launcher?" 10 60; then
        sudo rm -f /usr/bin/vsd-launcher
        sudo rm -f "$LOG_FILE"
        info "vsd-launcher desinstalado com sucesso."
        exit 0
    else
        info "Desinstalação cancelada."
    fi
}

# ========================
# EXECUÇÃO DO SCRIPT
# ========================
sudo touch "$LOG_FILE"
sudo chmod 666 "$LOG_FILE"

menu
